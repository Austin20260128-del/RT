<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元素組新進人員教育訓練系統 v1.5 (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        
        .custom-checkbox input:checked + div {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-900">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <p class="text-gray-500 animate-pulse">正在從雲端同步原始課程資料...</p>
    </div>

    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        <i class="fas fa-graduation-cap mr-2"></i>教育訓練系統 v1.5
                    </span>
                    <span id="syncStatus" class="ml-4 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-green-100 text-green-700">
                        <i class="fas fa-cloud mr-1"></i>已同步
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn active px-3 py-2 rounded-md text-sm font-medium text-gray-600 border border-transparent hover:border-gray-200">儀表板</button>
                    <button onclick="switchTab('initial')" id="btn-initial" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-600 border border-transparent hover:border-gray-200">必修課程</button>
                    <button onclick="switchTab('courses')" id="btn-courses" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-600 border border-transparent hover:border-gray-200">評分項目</button>
                    <div class="h-6 w-[1px] bg-gray-200 mx-2"></div>
                    <button onclick="exportToExcel()" class="hidden md:flex items-center px-3 py-2 rounded-md text-sm font-medium text-emerald-600 hover:bg-emerald-50">
                        <i class="fas fa-file-excel mr-1 text-emerald-500"></i>匯出
                    </button>
                    <button onclick="resetData()" class="px-3 py-2 rounded-md text-sm font-medium text-rose-600 hover:bg-rose-50">
                        <i class="fas fa-redo-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- TAB 1: DASHBOARD -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                    <h2 class="text-lg font-bold text-gray-800">基本資料與等級</h2>
                    <span id="userIdDisplay" class="text-[10px] text-gray-400 font-mono italic">ID: Connecting...</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">姓名</label>
                        <input type="text" id="userName" oninput="debouncedSave()" class="block w-full rounded-lg border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 bg-gray-50" placeholder="請輸入姓名">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">區域</label>
                        <select id="userRegion" onchange="debouncedSave()" class="block w-full rounded-lg border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 bg-gray-50">
                            <option value="">選擇區域</option>
                            <option value="北區">北區</option>
                            <option value="中區">中區</option>
                            <option value="南區">南區</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">到職日</label>
                        <input type="date" id="startDate" oninput="debouncedSave()" class="block w-full rounded-lg border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 bg-gray-50">
                    </div>
                    <div class="flex flex-col justify-center items-center md:items-end">
                        <div id="displayLevel" class="text-4xl font-black text-blue-600 italic">Lv 0</div>
                        <div class="text-[10px] text-gray-400 mt-1 uppercase tracking-widest font-bold">Current Rank</div>
                    </div>
                </div>
            </div>

            <!-- Score Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-xl shadow-lg p-6 text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-xs font-bold opacity-70 uppercase tracking-wider">目前總積分</div>
                        <div class="text-5xl font-black mt-1" id="displayTotalScore">0</div>
                        <div class="mt-4 flex items-center text-sm">
                            <span class="bg-white/20 px-2 py-0.5 rounded mr-2">總分比率: <span id="displayScoreRatio">0%</span></span>
                            <span class="opacity-70">Total Growth</span>
                        </div>
                    </div>
                    <i class="fas fa-chart-line absolute -bottom-4 -right-4 text-8xl opacity-10"></i>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-between">
                    <div>
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">晉升下個等級 (<span id="nextLevelName" class="text-blue-600">Lv 1</span>)</div>
                        <div class="flex items-baseline">
                            <span class="text-4xl font-black text-gray-800" id="displayDistToUpgrade">15</span>
                            <span class="ml-2 text-gray-400 text-sm italic">pts left</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-100 rounded-full h-3">
                            <div class="bg-blue-500 h-3 rounded-full transition-all duration-1000" id="levelProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">評分上限總計</div>
                    <div class="text-4xl font-black text-gray-800" id="displayMaxScore">487</div>
                    <div class="mt-3 flex items-center text-sm text-blue-600 font-medium italic">
                        <i class="fas fa-trophy mr-2"></i> 核心目標：487 分全滿
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Analysis Tables -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700"><i class="fas fa-tasks mr-2 text-blue-500"></i>階段進度 (Course Analysis)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-100">
                            <thead class="bg-gray-50/50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">類別</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">總分/額</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">目前得分</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">完成度</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50" id="courseAnalysisBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700"><i class="fas fa-tags mr-2 text-indigo-500"></i>品牌分析 (Brand Analysis)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-100">
                            <thead class="bg-gray-50/50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">品牌</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">目標課堂</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">已完成</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase">熟練度</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50" id="brandAnalysisBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: INITIAL COURSE -->
        <div id="initial" class="tab-content space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-5 border-b border-gray-100 bg-amber-50/30 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-amber-900">初始課程 (不計分，必須完成)</h3>
                        <p class="text-xs text-amber-600 mt-0.5">包含管理部、資訊組與基本操作教學</p>
                    </div>
                    <div class="bg-white px-3 py-1 rounded-full border border-amber-200 text-xs font-bold text-amber-700">
                        進度: <span id="initialProgress">0/10</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold text-gray-400 uppercase text-[10px]">狀態</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-400 uppercase text-[10px]">類別</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-400 uppercase text-[10px]">課程名稱</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-400 uppercase text-[10px]">時數</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-400 uppercase text-[10px]">主講人</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-400 uppercase text-[10px]">備註</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50" id="initialCourseList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 3: COURSE SELECTION -->
        <div id="courses" class="tab-content space-y-8">
            <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 flex items-start">
                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                <p class="text-blue-800 text-xs leading-relaxed">
                    請依序完成各等級課程。勾選後分數會自動累計至儀表板並同步雲端。
                </p>
            </div>
            
            <div id="scoredCourseSections" class="space-y-6">
                <!-- Sections rendered by JS -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from screenshot)
        const firebaseConfig = {
            apiKey: "AIzaSyCvOqKFvnKXrj07BtfbLLTNZXiCw2jBgus",
            authDomain: "training-834e3.firebaseapp.com",
            projectId: "training-834e3",
            storageBucket: "training-834e3.firebasestorage.app",
            messagingSenderId: "284421517335",
            appId: "1:284421517335:web:19e2d463497126b8ccac52",
            measurementId: "G-TBK012JC7N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "training-834e3-v1-5-sync";

        // --- Original Data Restoration ---
        
        const initialCoursesData = [
            { id: 'i1', category: '管理部課程', name: '繳交個人資料、填寫文件', time: '30 分鐘', lecturer: '王淑英', remark: '' },
            { id: 'i2', category: '管理部課程', name: '辦公室環境介紹 (茶水間、話機、WIFI)', time: '20 分鐘', lecturer: '許鏸文', remark: 'Rightek-guest密碼...' },
            { id: 'i3', category: '資訊組', name: '資安課程 (含設定E-mail及影印機)', time: '1 小時', lecturer: '彭一平', remark: '連絡 汎泰-資訊部' },
            { id: 'i4', category: '管理部課程', name: '員工手冊說明 (所有章節、單據)', time: '50 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i5', category: '管理部課程', name: '國貿常識 (台/外幣、外購)', time: '30 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i6', category: '管理部課程', name: '震旦行操作教學', time: '15 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i7', category: '管理部課程', name: '4 週彈性工時', time: '30 分鐘', lecturer: '林芳', remark: '' },
            { id: 'i8', category: '管理部課程', name: 'NDA', time: '30 分鐘', lecturer: '林芳', remark: '' },
            { id: 'i9', category: '業務部課程', name: 'CRM 操作教學', time: '30 分鐘', lecturer: '吳奕汶', remark: '10:00 ~ 12:00' },
            { id: 'i10', category: '管理部課程', name: '估價單 (報價規則)、成本分析', time: '40 分鐘', lecturer: '許鏸文', remark: '' }
        ];

        const courseData = [
            // Lv 1 - Total 4
            { id: 'c1_1', level: '新手篇', category: '教育訓練類', brand: null, name: '勇於介紹自己(一)', points: 1, desc: '加入公司的Line，完成自我介紹' },
            { id: 'c1_2', level: '新手篇', category: '教育訓練類', brand: null, name: '勇於介紹自己(二)', points: 1, desc: '跟公司所有人聯絡，了解負責工作' },
            { id: 'c1_3', level: '新手篇', category: '教育訓練類', brand: null, name: '能夠使用CRM工具', points: 1, desc: '完成一個沒有錯誤的Daily Report' },
            { id: 'c1_4', level: '新手篇', category: '教育訓練類', brand: null, name: '參與新手訓練課程', points: 1, desc: '完成全部初始介紹課程' },

            // Lv 2 - Total 153
            { id: 'c2_1', level: '理解篇', category: '公司理解', brand: null, name: '理解自己的公司', points: 3, desc: '做正式的利泓介紹，通過組長考核' },
            { id: 'c2_2', level: '理解篇', category: '銷售觀摩', brand: null, name: '觀摩其他人的模式', points: 3, desc: '陪同拜訪四次並撰寫Report' },
            { id: 'c2_m1', level: '理解篇', category: '產品理解', brand: 'Milestone', name: 'Milestone 基礎產品知識', points: 5, desc: '產品線總覽與應用' },
            { id: 'c2_m2', level: '理解篇', category: '產品理解', brand: 'Milestone', name: 'Milestone 微波消化原理', points: 5, desc: '核心技術解說' },
            { id: 'c2_m3', level: '理解篇', category: '產品理解', brand: 'Milestone', name: 'Milestone 耗材與配件', points: 5, desc: '識別常用配件' },
            { id: 'c2_l1', level: '理解篇', category: '產品理解', brand: 'Labtech', name: 'Labtech 產品概論', points: 5, desc: '品牌與產品線介紹' },
            { id: 'c2_l2', level: '理解篇', category: '產品理解', brand: 'Labtech', name: 'Labtech 冷卻系統', points: 5, desc: 'Chiller 原理與銷售' },
            { id: 'c2_a1', level: '理解篇', category: '產品理解', brand: 'Analytik Jena', name: 'AJ 光議器原理 (AAS)', points: 5, desc: '原子吸收光譜基礎' },
            { id: 'c2_a2', level: '理解篇', category: '產品理解', brand: 'Analytik Jena', name: 'AJ ICP-OES 介紹', points: 5, desc: '電感耦合電漿光譜儀' },
            { id: 'c2_a3', level: '理解篇', category: '產品理解', brand: 'Analytik Jena', name: 'AJ 元素分析 (EA)', points: 5, desc: 'C/N/S/Cl 分析原理' },
            { id: 'c2_as1', level: '理解篇', category: '產品理解', brand: 'Applied Spectra', name: 'LIBS 技術簡介', points: 5, desc: '雷射誘導崩解光譜' },
            { id: 'c2_g1', level: '理解篇', category: '產品理解', brand: 'Metal Power', name: '金屬分析儀基礎', points: 5, desc: 'OES 原理' },
            { id: 'c2_fill1', level: '理解篇', category: '通用技能', brand: null, name: '實驗室基礎安全', points: 10, desc: '化學品處理與防護' },
            { id: 'c2_fill2', level: '理解篇', category: '通用技能', brand: null, name: '基本報價邏輯', points: 10, desc: '利潤計算與稅務' },
            { id: 'c2_fill3', level: '理解篇', category: '通用技能', brand: null, name: '競爭對手分析', points: 10, desc: '市場主要競品調查' },
            { id: 'c2_fill4', level: '理解篇', category: '通用技能', brand: null, name: '客戶產業分布', points: 10, desc: '半導體/石化/學研' },
            { id: 'c2_fill5', level: '理解篇', category: '通用技能', brand: null, name: '標案流程理解', points: 12, desc: '政府採購網操作與規範' },
            { id: 'c2_fill6', level: '理解篇', category: '通用技能', brand: null, name: '軟體操作基礎', points: 10, desc: '各儀器軟體介面熟悉' },
            { id: 'c2_fill7', level: '理解篇', category: '通用技能', brand: null, name: '樣品前處理', points: 10, desc: '酸消化與稀釋技巧' },
            { id: 'c2_fill8', level: '理解篇', category: '通用技能', brand: null, name: '法規知識', points: 10, desc: '環保法規與檢測標準' },
            { id: 'c2_fill9', level: '理解篇', category: '通用技能', brand: null, name: '業務話術演練', points: 10, desc: '針對不同客戶的應對' },

            // Lv 3 - Total 80
            { id: 'c3_1', level: '規劃篇', category: '銷售規劃', brand: null, name: '學習開發客戶(一)', points: 10, desc: '完成五次陌生電話拜訪，約訪到客戶' },
            { id: 'c3_2', level: '規劃篇', category: '銷售規劃', brand: null, name: '學習開發客戶(二)', points: 10, desc: '完成五次陌生拜訪，約訪到客戶' },
            { id: 'c3_3', level: '規劃篇', category: '銷售規劃', brand: null, name: '學習開發客戶(三)', points: 10, desc: '完成五次陌生信件拜訪，約訪到客戶' },
            { id: 'c3_4', level: '規劃篇', category: '策略規劃', brand: null, name: '規劃銷售策略', points: 10, desc: '設定一個產品線的銷售規劃' },
            { id: 'c3_5', level: '規劃篇', category: '行銷規劃', brand: null, name: '規劃行銷策略', points: 10, desc: '設定一個產品線的市場行銷策略' },
            { id: 'c3_6', level: '規劃篇', category: '自我管理', brand: null, name: '安排休息時間', points: 10, desc: '完成一個請假程序，沒有錯誤' },
            { id: 'c3_7', level: '規劃篇', category: '區域管理', brand: null, name: '區域客戶地圖', points: 10, desc: '建立負責區域的客戶分佈圖' },
            { id: 'c3_8', level: '規劃篇', category: '專案管理', brand: null, name: '專案時程控管', points: 10, desc: '模擬一個案子的從頭到尾時程' },

            // Lv 4 - Total 225
            { id: 'c4_1', level: '團隊合作篇', category: '售後合作', brand: null, name: '了解如何跟售後團隊合作', points: 15, desc: '參與產品售後流程並提供記錄' },
            { id: 'c4_m1', level: '團隊合作篇', category: '裝機訓練', brand: 'Milestone', name: 'Milestone 裝機與教育訓練', points: 15, desc: '參與三次不同機型裝機' },
            { id: 'c4_m2', level: '團隊合作篇', category: '售後服務', brand: 'Milestone', name: 'Milestone 售後服務案', points: 15, desc: '參與兩次不同機型售後服務' },
            { id: 'c4_a1', level: '團隊合作篇', category: '裝機訓練', brand: 'Analytik Jena', name: 'AAS 裝機與教育訓練', points: 15, desc: '參與兩次 AAS 裝機' },
            { id: 'c4_a2', level: '團隊合作篇', category: '售後服務', brand: 'Analytik Jena', name: 'TOC 售後服務案', points: 15, desc: '參與兩次 TOC 售後服務' },
            { id: 'c4_l1', level: '團隊合作篇', category: '裝機訓練', brand: 'Labtech', name: 'Labtech 裝機實習', points: 15, desc: '參與裝機流程' },
            { id: 'c4_f1', level: '團隊合作篇', category: '團隊協作', brand: null, name: '跨部門溝通', points: 15, desc: '協助處理一件跨部門客訴' },
            { id: 'c4_f2', level: '團隊合作篇', category: '經驗分享', brand: null, name: '內部教育訓練講師', points: 30, desc: '擔任一次內部產品主講人' },
            { id: 'c4_f3', level: '團隊合作篇', category: '專案支援', brand: null, name: '支援同事案子', points: 15, desc: '協助同事完成Demo或送樣' },
            { id: 'c4_f4', level: '團隊合作篇', category: '展覽活動', brand: null, name: '參展執行', points: 15, desc: '參與一次公司參展活動' },
            { id: 'c4_f5', level: '團隊合作篇', category: '文件製作', brand: null, name: '技術文件翻譯', points: 30, desc: '完成一份原廠技術手冊中文化' },
            { id: 'c4_f6', level: '團隊合作篇', category: '影片製作', brand: null, name: '操作影片錄製', points: 30, desc: '錄製一段儀器簡易操作影片' },

            // Self Growth - Total 25
            { id: 'cg_1', level: '自我成長', category: '成長', brand: null, name: '閱讀分享', points: 5, desc: '分享一本相關書籍心得' },
            { id: 'cg_2', level: '自我成長', category: '成長', brand: null, name: '外部課程', points: 10, desc: '參加一次外部相關研討會' },
            { id: 'cg_3', level: '自我成長', category: '成長', brand: null, name: '語言能力', points: 10, desc: '提升外語能力證明' }
        ];

        const levelThresholds = [
            { level: 0, min: 0, next: 15 },
            { level: 1, min: 15, next: 65 },
            { level: 2, min: 65, next: 180 },
            { level: 3, min: 180, next: 350 },
            { level: 4, min: 350, next: 430 },
            { level: 5, min: 430, next: null }
        ];

        const brandTargets = {
            'Milestone': 20, 'Labtech': 8, 'Analytik Jena': 17, 'Applied Spectra': 6, 'Metal Power': 5
        };

        // --- App State & Firebase logic ---

        let appState = {
            userInfo: { name: '', region: '', startDate: '' },
            completedInitial: [],
            completedCourses: []
        };
        let saveTimeout = null;

        window.onload = async () => {
            renderInitialList();
            renderScoredSections();
            initAuth();
        };

        async function initAuth() {
            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                document.getElementById('userIdDisplay').innerText = `ID: ${user.uid}`;
                setupSync(user.uid);
            } catch (error) {
                console.error("Firebase auth error", error);
                document.getElementById('loadingOverlay').innerHTML = `<p class="text-red-500">雲端連線失敗，請檢查網路。</p>`;
            }
        }

        function setupSync(uid) {
            const docRef = doc(db, 'artifacts', appId, 'users', uid, 'state', 'current');
            
            getDoc(docRef).then((snap) => {
                if (snap.exists()) {
                    appState = snap.data();
                    document.getElementById('userName').value = appState.userInfo.name || '';
                    document.getElementById('userRegion').value = appState.userInfo.region || '';
                    document.getElementById('startDate').value = appState.userInfo.startDate || '';
                }
                updateAllUI();
                document.getElementById('loadingOverlay').classList.add('hidden');
            });

            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (JSON.stringify(data) !== JSON.stringify(appState)) {
                        appState = data;
                        updateAllUI();
                    }
                }
            });
        }

        function debouncedSave() {
            appState.userInfo.name = document.getElementById('userName').value;
            appState.userInfo.region = document.getElementById('userRegion').value;
            appState.userInfo.startDate = document.getElementById('startDate').value;
            
            updateAllUI();
            
            setSyncing(true);
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (!auth.currentUser) return;
                const docRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'state', 'current');
                await setDoc(docRef, appState);
                setSyncing(false);
            }, 1000);
        }

        function setSyncing(isSyncing) {
            const el = document.getElementById('syncStatus');
            if (isSyncing) {
                el.innerHTML = `<i class="fas fa-sync animate-spin mr-1"></i>同步中`;
                el.className = "ml-4 px-2 py-1 rounded text-[10px] font-bold bg-blue-100 text-blue-700";
            } else {
                el.innerHTML = `<i class="fas fa-cloud mr-1"></i>已同步`;
                el.className = "ml-4 px-2 py-1 rounded text-[10px] font-bold bg-green-100 text-green-700";
            }
        }

        // --- UI Rendering ---

        function renderInitialList() {
            const tbody = document.getElementById('initialCourseList');
            tbody.innerHTML = initialCoursesData.map(c => `
                <tr class="hover:bg-gray-50/50">
                    <td class="px-4 py-3">
                        <label class="custom-checkbox flex items-center cursor-pointer">
                            <input type="checkbox" class="hidden" data-id="${c.id}" onchange="toggleInitial('${c.id}')">
                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center">
                                <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </label>
                    </td>
                    <td class="px-4 py-3 text-gray-500 font-medium">${c.category}</td>
                    <td class="px-4 py-3 text-gray-900 font-bold">${c.name}</td>
                    <td class="px-4 py-3 text-gray-500">${c.time}</td>
                    <td class="px-4 py-3 text-gray-500">${c.lecturer}</td>
                    <td class="px-4 py-3 text-xs text-gray-400 italic">${c.remark}</td>
                </tr>
            `).join('');
        }

        function renderScoredSections() {
            const container = document.getElementById('scoredCourseSections');
            const levels = ['新手篇', '理解篇', '規劃篇', '團隊合作篇', '自我成長'];
            
            container.innerHTML = levels.map(lv => {
                const items = courseData.filter(c => c.level === lv);
                const lvTotal = items.reduce((acc, c) => acc + c.points, 0);
                
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 flex justify-between items-center cursor-pointer" onclick="toggleSection('sec-${lv}')">
                            <h3 class="font-bold text-gray-700">${lv} <span class="text-xs font-normal text-gray-400 ml-2">(${lvTotal} 分)</span></h3>
                            <i class="fas fa-chevron-down text-gray-300"></i>
                        </div>
                        <div id="sec-${lv}" class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-100 text-sm">
                                <thead class="bg-gray-50/20">
                                    <tr>
                                        <th class="w-16 px-4 py-3">完成</th>
                                        <th class="px-4 py-3 text-left">類別/品牌</th>
                                        <th class="px-4 py-3 text-left">課程項目</th>
                                        <th class="px-4 py-3 text-left">分數</th>
                                        <th class="px-4 py-3 text-left">說明</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${items.map(c => `
                                        <tr>
                                            <td class="px-4 py-3 text-center">
                                                <label class="custom-checkbox inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" class="hidden" data-id="${c.id}" onchange="toggleCourse('${c.id}')">
                                                    <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center">
                                                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                                    </div>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 text-indigo-600 font-bold">${c.brand || c.category}</td>
                                            <td class="px-4 py-3 text-gray-800 font-bold">${c.name}</td>
                                            <td class="px-4 py-3 font-black text-blue-600">${c.points}</td>
                                            <td class="px-4 py-3 text-xs text-gray-400">${c.desc}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAllUI() {
            // Checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const id = cb.getAttribute('data-id');
                cb.checked = appState.completedInitial.includes(id) || appState.completedCourses.includes(id);
            });

            // Score Logic
            let total = 0;
            const catStats = { '新手篇': {t:0, c:0}, '理解篇': {t:0, c:0}, '規劃篇': {t:0, c:0}, '團隊合作篇': {t:0, c:0}, '自我成長': {t:0, c:0} };
            const brandStats = {};
            
            courseData.forEach(c => {
                catStats[c.level].t += c.points;
                if (appState.completedCourses.includes(c.id)) {
                    total += c.points;
                    catStats[c.level].c += c.points;
                    if (c.brand) brandStats[c.brand] = (brandStats[c.brand] || 0) + 1;
                }
            });

            // Mandatory Logic
            const iTotal = initialCoursesData.length;
            const iDone = appState.completedInitial.length;
            const iPct = Math.round((iDone / iTotal) * 100);

            // Dashboard Numbers
            document.getElementById('displayTotalScore').innerText = total;
            let curLv = levelThresholds[0];
            for(let l of levelThresholds) { if(total >= l.min) curLv = l; else break; }
            document.getElementById('displayLevel').innerText = 'Lv ' + curLv.level;
            document.getElementById('displayScoreRatio').innerText = Math.round((total / 487) * 100) + '%';
            
            if(curLv.next) {
                document.getElementById('displayDistToUpgrade').innerText = curLv.next - total;
                document.getElementById('nextLevelName').innerText = 'Lv ' + (curLv.level + 1);
                document.getElementById('levelProgressBar').style.width = ((total - curLv.min) / (curLv.next - curLv.min) * 100) + '%';
            } else {
                document.getElementById('displayDistToUpgrade').innerText = 'MAX';
                document.getElementById('nextLevelName').innerText = '最高等級';
                document.getElementById('levelProgressBar').style.width = '100%';
            }

            // Phase Progress Table
            const catBody = document.getElementById('courseAnalysisBody');
            let catRows = `
                <tr class="bg-amber-50/40">
                    <td class="px-6 py-4 text-sm font-bold text-amber-700">必修課程 (Mandatory)</td>
                    <td class="px-6 py-4 text-xs text-gray-400">${iTotal} 項目</td>
                    <td class="px-6 py-4 text-sm font-black text-amber-600">${iDone}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-bold text-gray-400">${iPct}%</span>
                            <div class="w-12 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-500" style="width: ${iPct}%"></div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            catRows += Object.entries(catStats).map(([name, data]) => {
                const pct = Math.round((data.c / data.t) * 100);
                return `
                    <tr>
                        <td class="px-6 py-4 text-sm font-bold text-gray-700">${name}</td>
                        <td class="px-6 py-4 text-xs text-gray-400">${data.t} 分</td>
                        <td class="px-6 py-4 text-sm font-black text-blue-600">${data.c}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-bold text-gray-400">${pct}%</span>
                                <div class="w-12 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${pct}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            catBody.innerHTML = catRows;

            // Brand Table
            document.getElementById('brandAnalysisBody').innerHTML = Object.entries(brandTargets).map(([name, target]) => {
                const current = brandStats[name] || 0;
                const pct = Math.round((current / target) * 100);
                return `
                    <tr>
                        <td class="px-6 py-4 text-sm font-bold text-gray-700">${name}</td>
                        <td class="px-6 py-4 text-xs text-gray-400">${target}</td>
                        <td class="px-6 py-4 text-sm font-bold text-indigo-600">${current}</td>
                        <td class="px-6 py-4">
                            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500" style="width: ${Math.min(100, pct)}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('initialProgress').innerText = `${iDone}/${iTotal}`;
        }

        // --- Event Handlers ---

        window.toggleInitial = (id) => {
            if (appState.completedInitial.includes(id)) appState.completedInitial = appState.completedInitial.filter(x => x !== id);
            else appState.completedInitial.push(id);
            debouncedSave();
        };

        window.toggleCourse = (id) => {
            if (appState.completedCourses.includes(id)) appState.completedCourses = appState.completedCourses.filter(x => x !== id);
            else appState.completedCourses.push(id);
            debouncedSave();
        };

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
        };

        window.toggleSection = (id) => document.getElementById(id).classList.toggle('hidden');

        window.resetData = async () => {
            if(!confirm("警告：此操作將重置雲端資料庫中您的所有學習進度。確定嗎？")) return;
            appState = { userInfo: { name: '', region: '', startDate: '' }, completedInitial: [], completedCourses: [] };
            debouncedSave();
        };

        window.exportToExcel = () => {
            const wb = XLSX.utils.book_new();
            const summary = [
                ["基本資料"],
                ["姓名", appState.userInfo.name],
                ["得分", document.getElementById('displayTotalScore').innerText],
                ["等級", document.getElementById('displayLevel').innerText]
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), "個人報表");
            XLSX.writeFile(wb, `元素組培訓進度_${appState.userInfo.name || 'User'}.xlsx`);
        };

        // Attach input events
        document.getElementById('userName').oninput = debouncedSave;
        document.getElementById('userRegion').onchange = debouncedSave;
        document.getElementById('startDate').oninput = debouncedSave;

    </script>
</body>
</html>
