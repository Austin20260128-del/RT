<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元素組教育訓練系統 v1.5 (Firebase 同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; } [cite: 1, 2]
        .tab-content { display: none; } [cite: 3]
        .tab-content.active { display: block; } [cite: 4]
        .nav-btn.active { background-color: #2563eb; color: white; } [cite: 5]
        .custom-checkbox input:checked + div { background-color: #2563eb; border-color: #2563eb; } [cite: 6]
        .custom-checkbox input:checked + div svg { display: block; } [cite: 7]
    </style>
</head>
<body>
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-gray-800"><i class="fas fa-graduation-cap text-blue-600 mr-2"></i>教育訓練系統 v1.5</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn active px-3 py-2 rounded-md text-sm font-medium">個人資料儀表板</button>
                    <button onclick="switchTab('initial')" id="btn-initial" class="nav-btn px-3 py-2 rounded-md text-sm font-medium">初始課程 (必修)</button>
                    <button onclick="switchTab('courses')" id="btn-courses" class="nav-btn px-3 py-2 rounded-md text-sm font-medium">課程選擇 (計分)</button>
                    <button onclick="exportToExcel()" class="px-3 py-2 rounded-md text-sm font-medium text-green-600 hover:bg-green-50 border border-green-200">匯出 Excel</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">基本資料 (輸入姓名後自動載入雲端進度)</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">姓名 (同步關鍵字)</label>
                        <input type="text" id="userName" onchange="initFirebaseSync()" class="mt-1 block w-full rounded-md border p-2" placeholder="輸入姓名後按Enter">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">區域</label>
                        <select id="userRegion" onchange="saveToFirebase()" class="mt-1 block w-full rounded-md border p-2">
                            <option value="">選擇區域</option>
                            <option value="北區">北區</option> [cite: 13]
                            <option value="中區">中區</option> [cite: 14]
                            <option value="南區">南區</option> [cite: 14]
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">到職日</label>
                        <input type="date" id="startDate" onchange="saveToFirebase()" class="mt-1 block w-full rounded-md border p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">目前等級</label>
                        <div id="displayLevel" class="mt-1 text-2xl font-bold text-blue-600">Lv 0</div> [cite: 16]
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white">
                    <div class="text-sm opacity-80">目前總得分</div>
                    <div class="text-4xl font-bold" id="displayTotalScore">0</div> [cite: 18]
                </div>
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-400">
                    <div class="text-sm text-gray-500">距離下一等級 (<span id="nextLevelName">Lv 1</span>)</div>
                    <div class="text-4xl font-bold text-gray-800" id="displayDistToUpgrade">15</div> [cite: 19]
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div class="bg-yellow-400 h-2.5 rounded-full" id="levelProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                    <div class="text-sm text-gray-500">所有學分總額</div>
                    <div class="text-4xl font-bold text-gray-800">487</div> [cite: 20]
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-6 py-4 border-b bg-gray-50"><h3 class="font-bold">課程分析</h3></div>
                    <table class="min-w-full divide-y divide-gray-200"><tbody id="courseAnalysisBody"></tbody></table>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-6 py-4 border-b bg-gray-50"><h3 class="font-bold">品牌分析</h3></div>
                    <table class="min-w-full divide-y divide-gray-200"><tbody id="brandAnalysisBody"></tbody></table>
                </div>
            </div>
        </div>

        <div id="initial" class="tab-content space-y-6">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b bg-yellow-50 flex justify-between">
                    <h3 class="font-bold">初始課程 (進度: <span id="initialProgress">0/10</span>)</h3>
                </div>
                <table class="min-w-full text-sm"><tbody id="initialCourseList"></tbody></table>
            </div>
        </div>
        <div id="courses" class="tab-content space-y-6">
            <div id="lv1-container" class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-3 bg-gray-100 font-bold">Lv.1 新手篇 (4 分)</div>
                <table class="min-w-full text-sm"><tbody id="lv1-rows"></tbody></table>
            </div>
            <div id="lv2-container" class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-3 bg-gray-100 font-bold">Lv.2 理解篇 (153 分)</div>
                <table class="min-w-full text-sm"><tbody id="lv2-rows"></tbody></table>
            </div>
            <div id="lv3-container" class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-3 bg-gray-100 font-bold">Lv.3 規劃篇 (80 分)</div>
                <table class="min-w-full text-sm"><tbody id="lv3-rows"></tbody></table>
            </div>
            <div id="lv4-container" class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-3 bg-gray-100 font-bold">Lv.4 團隊合作篇 (225 分)</div>
                <table class="min-w-full text-sm"><tbody id="lv4-rows"></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvOqKFvnKXrj07BtfbLLTNZXiCw2jBgus",
            authDomain: "training-834e3.firebaseapp.com",
            projectId: "training-834e3",
            databaseURL: "https://training-834e3-default-rtdb.firebaseio.com",
            storageBucket: "training-834e3.firebasestorage.app",
            messagingSenderId: "284421517335",
            appId: "1:284421517335:web:19e2d463497126b8ccac52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 將 Firebase 函式掛載到全域以便 HTML 調用
        window.initFirebaseSync = function() {
            const name = document.getElementById('userName').value;
            if(!name) return;
            
            const userRef = ref(db, 'users/' + name);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    window.appState = data;
                    document.getElementById('userRegion').value = data.userInfo.region || '';
                    document.getElementById('startDate').value = data.userInfo.startDate || '';
                    renderInitialCourses();
                    renderScoredCourses();
                    updateDashboard();
                }
            });
        };

        window.saveToFirebase = function() {
            const name = document.getElementById('userName').value;
            if(!name) return;
            
            window.appState.userInfo = {
                name: name,
                region: document.getElementById('userRegion').value,
                startDate: document.getElementById('startDate').value
            };
            
            set(ref(db, 'users/' + name), window.appState);
        };
    </script>

    <script>
        // 資料結構 [cite: 67, 70, 71, 72, 73, 74, 75, 79, 80, 81, 82, 83, 84, 85, 86]
        const initialCoursesData = [
            { id: 'i1', category: '管理部課程', name: '繳交個人資料、填寫文件', time: '30 分鐘', lecturer: '王淑英', remark: '' },
            { id: 'i2', category: '管理部課程', name: '辦公室環境介紹', time: '20 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i3', category: '資訊組', name: '資安課程', time: '1 小時', lecturer: '彭一平', remark: '' },
            { id: 'i4', category: '管理部課程', name: '員工手冊說明', time: '50 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i5', category: '管理部課程', name: '國貿常識', time: '30 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i6', category: '管理部課程', name: '震旦行操作教學', time: '15 分鐘', lecturer: '許鏸文', remark: '' },
            { id: 'i7', category: '管理部課程', name: '4 週彈性工時', time: '30 分鐘', lecturer: '林芳', remark: '' },
            { id: 'i8', category: '管理部課程', name: 'NDA', time: '30 分鐘', lecturer: '林芳', remark: '' },
            { id: 'i9', category: '業務部課程', name: 'CRM 操作教學', time: '30 分鐘', lecturer: '吳奕汶', remark: '' },
            { id: 'i10', category: '管理部課程', name: '估價單/成本分析', time: '40 分鐘', lecturer: '許鏸文', remark: '' }
        ];

        const courseData = [
            { id: 'c1_1', level: '新手篇', name: '勇於介紹自己(一)', points: 1, desc: 'Line自我介紹' },
            { id: 'c1_2', level: '新手篇', name: '勇於介紹自己(二)', points: 1, desc: '了解負責工作' },
            { id: 'c2_1', level: '理解篇', brand: 'Milestone', name: '基礎產品知識', points: 5, desc: '產品線總覽' },
            { id: 'c2_2', level: '理解篇', brand: 'Analytik Jena', name: 'ICP-OES 介紹', points: 5, desc: '光譜儀原理' },
            { id: 'c3_1', level: '規劃篇', name: '學習開發客戶(一)', points: 10, desc: '五次約訪' },
            { id: 'c4_1', level: '團隊合作篇', brand: 'Milestone', name: '裝機實習', points: 15, desc: '參與裝機流程' }
        ];

        const levelThresholds = [
            { level: 0, min: 0, next: 15 },
            { level: 1, min: 15, next: 65 },
            { level: 2, min: 65, next: 180 },
            { level: 3, min: 180, next: 350 },
            { level: 4, min: 350, next: 430 },
            { level: 5, min: 430, next: null }
        ];

        window.appState = { userInfo: {}, completedInitial: [], completedCourses: [] };

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
        }

        function toggleInitial(id) {
            const idx = window.appState.completedInitial.indexOf(id);
            if (idx === -1) window.appState.completedInitial.push(id);
            else window.appState.completedInitial.splice(idx, 1);
            saveToFirebase();
        }

        function toggleCourse(id) {
            const idx = window.appState.completedCourses.indexOf(id);
            if (idx === -1) window.appState.completedCourses.push(id);
            else window.appState.completedCourses.splice(idx, 1);
            saveToFirebase();
        }

        function renderInitialCourses() {
            const tbody = document.getElementById('initialCourseList');
            tbody.innerHTML = initialCoursesData.map(c => `
                <tr class="border-b">
                    <td class="p-3"><input type="checkbox" ${window.appState.completedInitial.includes(c.id) ? 'checked' : ''} onchange="toggleInitial('${c.id}')"></td>
                    <td class="p-3">${c.category}</td>
                    <td class="p-3 font-medium">${c.name}</td>
                    <td class="p-3">${c.time}</td>
                    <td class="p-3">${c.lecturer}</td>
                </tr>
            `).join('');
            document.getElementById('initialProgress').innerText = `${window.appState.completedInitial.length}/${initialCoursesData.length}`;
        }

        function renderScoredCourses() {
            const levels = ['新手篇', '理解篇', '規劃篇', '團隊合作篇'];
            levels.forEach((lv, i) => {
                const tbody = document.getElementById(`lv${i+1}-rows`);
                tbody.innerHTML = courseData.filter(c => c.level === lv).map(c => `
                    <tr class="border-b">
                        <td class="p-3"><input type="checkbox" ${window.appState.completedCourses.includes(c.id) ? 'checked' : ''} onchange="toggleCourse('${c.id}')"></td>
                        <td class="p-3">${c.brand || '通用'}</td>
                        <td class="p-3 font-medium">${c.name}</td>
                        <td class="p-3 font-bold text-blue-600">${c.points}</td>
                    </tr>
                `).join('');
            });
        }

        function updateDashboard() {
            let score = 0;
            courseData.forEach(c => {
                if(window.appState.completedCourses.includes(c.id)) score += c.points;
            });
            document.getElementById('displayTotalScore').innerText = score;
            
            let curLv = levelThresholds.find(l => score >= l.min && (l.next === null || score < l.next));
            document.getElementById('displayLevel').innerText = 'Lv ' + curLv.level;
            if(curLv.next) {
                document.getElementById('displayDistToUpgrade').innerText = curLv.next - score;
                document.getElementById('nextLevelName').innerText = 'Lv ' + (curLv.level + 1);
                const percent = ((score - curLv.min) / (curLv.next - curLv.min)) * 100;
                document.getElementById('levelProgressBar').style.width = percent + '%';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderInitialCourses();
            renderScoredCourses();
        });
    </script>
</body>
</html>
