<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹å¸«å·¥å…·ç®¡ç†ç³»çµ± - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; font-size: 14px; }
        .status-badge { @apply px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider whitespace-nowrap; }
        .row-borrowed { @apply bg-amber-50/40; }
        .loading-overlay { @apply fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center text-white font-bold flex-col gap-4; }
        /* é˜²æ­¢æ›è¡Œèˆ‡æ”¯æ´å»¶ä¼¸ */
        .no-wrap { white-space: nowrap; }
        /* å±¥æ­·æ™‚é–“è»¸æ¨£å¼ */
        .timeline-container { position: relative; padding-left: 1.5rem; }
        .timeline-line { position: absolute; left: 5px; top: 5px; bottom: 5px; width: 2px; background-color: #e2e8f0; }
        .timeline-item { position: relative; margin-bottom: 1rem; }
        .timeline-dot { position: absolute; left: -24px; top: 4px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; z-index: 10; }
    </style>
</head>
<body class="text-slate-800">

<div id="loadingOverlay" class="loading-overlay">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent"></div>
    <p class="text-sm">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
</div>

<div id="app" class="min-h-screen flex flex-col">
    <nav class="bg-slate-900 text-white shadow-xl p-3 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="location.reload()">
                <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="wrench" class="w-5 h-5 text-white"></i></div>
                <div>
                    <h1 class="text-base font-bold leading-tight">é›²ç«¯è³‡ç”¢ç®¡ç†</h1>
                    <p class="text-[9px] text-slate-400 tracking-widest uppercase">Office Asset Sync</p>
                </div>
            </div>
            <button onclick="openAddModal()" class="bg-indigo-600 hover:bg-indigo-50 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center space-x-1 shadow-lg shadow-indigo-500/20 transition-all">
                <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                <span>æ–°å¢å·¥å…·</span>
            </button>
        </div>
    </nav>

    <div class="container mx-auto p-3 md:p-6 flex-grow">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 text-center">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-[10px] uppercase font-bold">ç¸½å·¥å…·</p>
                <h3 id="statTotal" class="text-xl font-bold mt-0.5">0</h3>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-l-indigo-500">
                <p class="text-slate-500 text-[10px] uppercase font-bold">å¤–å€Ÿä¸­</p>
                <h3 id="statBorrowed" class="text-xl font-bold mt-0.5 text-indigo-600">0</h3>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-l-amber-500">
                <p class="text-slate-500 text-[10px] uppercase font-bold">é è­¦</p>
                <h3 id="statWarning" class="text-xl font-bold mt-0.5 text-amber-500">0</h3>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-l-red-500">
                <p class="text-slate-500 text-[10px] uppercase font-bold">éæœŸ</p>
                <h3 id="statExpired" class="text-xl font-bold mt-0.5 text-red-500">0</h3>
            </div>
        </div>

        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 mb-4 flex flex-wrap gap-2 items-center">
            <div class="relative flex-grow min-w-[200px]">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                <input type="text" id="searchInput" oninput="renderTools()" placeholder="æœå°‹..." class="w-full pl-9 pr-3 py-2 rounded-lg bg-slate-50 text-xs outline-none focus:ring-2 focus:ring-indigo-500 transition-all border border-transparent focus:border-indigo-500">
            </div>
            <select id="officeFilter" onchange="renderTools()" class="px-2 py-2 rounded-lg bg-slate-50 text-xs font-bold outline-none border border-slate-200">
                <option value="all">å…¨å€</option>
                <option value="å°åŒ—">å°åŒ—</option>
                <option value="å°ä¸­">å°ä¸­</option>
                <option value="é«˜é›„">é«˜é›„</option>
            </select>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-slate-50 border-b text-slate-400 text-[10px] font-black uppercase tracking-widest whitespace-nowrap">
                            <th class="p-3">å·¥å…·è³‡è¨Š (å‹è™Ÿ/åºè™Ÿ/è² è²¬äºº)</th>
                            <th class="p-3">æ‰€åœ¨åœ°</th>
                            <th class="p-3">æ ¡æ­£</th>
                            <th class="p-3">ç‹€æ…‹</th>
                            <th class="p-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="toolTableBody" class="divide-y divide-slate-100 text-[13px]"></tbody>
                </table>
            </div>
            <div id="noData" class="hidden p-10 text-center text-slate-400 text-xs">æŸ¥ç„¡ç›¸é—œè³‡æ–™</div>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-[70] p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden h-[70vh] flex flex-col">
            <div class="p-4 bg-indigo-50 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-bold text-indigo-900">è³‡ç”¢å®Œæ•´å±¥æ­·</h2>
                    <p id="historyToolName" class="text-[10px] text-indigo-600 font-medium"></p>
                </div>
                <button onclick="closeModal('historyModal')" class="p-1.5 hover:bg-indigo-100 rounded-full text-indigo-900"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-5 overflow-y-auto flex-grow bg-white">
                <div class="timeline-container text-xs">
                    <div class="timeline-line"></div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="borrowModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs shadow-2xl p-6 overflow-hidden">
            <h2 id="borrowTitle" class="text-base font-bold mb-1 text-center"></h2>
            <p id="borrowSub" class="text-slate-500 mb-4 text-center text-[11px]"></p>
            <input type="hidden" id="borrowToolId">
            <div id="borrowView">
                <input type="text" id="borrowerName" placeholder="å¡«å¯«å€Ÿç”¨äººå§“å" class="w-full px-3 py-3 rounded-xl border-2 text-center text-base font-bold outline-none focus:border-indigo-500">
            </div>
            <div id="returnView" class="hidden space-y-4 text-xs">
                <div class="flex gap-1 p-1 bg-slate-100 rounded-lg">
                    <button onclick="setReturnMode('return')" id="modeBtnReturn" class="flex-1 py-1.5 rounded-md font-bold transition-all">æ­¸é‚„</button>
                    <button onclick="setReturnMode('transfer')" id="modeBtnTransfer" class="flex-1 py-1.5 rounded-md font-bold transition-all">è½‰äº¤</button>
                </div>
                <div id="returnLocationArea">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">æ­¸é‚„è‡³è¾¦å…¬å®¤</label>
                    <select id="returnOffice" class="w-full px-3 py-2 rounded-lg border font-bold outline-none"><option value="å°åŒ—">å°åŒ—</option><option value="å°ä¸­">å°ä¸­</option><option value="é«˜é›„">é«˜é›„</option></select>
                </div>
                <div id="transferUserArea" class="hidden">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">è½‰äº¤çµ¦å·¥ç¨‹å¸«</label>
                    <input type="text" id="transferName" placeholder="æ¥æ”¶äººå§“å" class="w-full px-3 py-2 rounded-lg border text-center font-bold outline-none">
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button onclick="handleBorrowReturn()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-md">ç¢ºèªæäº¤</button>
                <button onclick="closeModal('borrowModal')" class="w-full text-slate-400 font-medium text-xs py-1">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="toolModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <h2 id="modalTitle" class="text-sm font-bold">è³‡ç”¢è³‡æ–™ç·¨è¼¯</h2>
                <button onclick="closeModal('toolModal')" class="p-1.5 hover:bg-slate-200 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <form id="toolForm" onsubmit="handleSaveTool(event)" class="p-5 space-y-3 text-xs">
                <input type="hidden" id="editToolId">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="block font-bold text-slate-500 mb-1">å·¥å…·åç¨±</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 rounded-lg border outline-none focus:ring-2 focus:ring-indigo-500/20">
                    </div>
                    <div><label class="block font-bold text-slate-500 mb-1">å‹è™Ÿ</label><input type="text" name="model" required class="w-full px-3 py-2 rounded-lg border outline-none"></div>
                    <div><label class="block font-bold text-slate-500 mb-1">åºè™Ÿ</label><input type="text" name="sn" required class="w-full px-3 py-2 rounded-lg border outline-none"></div>
                    <div class="col-span-2">
                        <label class="block font-bold text-indigo-600 mb-1">è² è²¬äºº</label>
                        <input type="text" name="owner" required class="w-full px-3 py-2 rounded-lg border-2 border-indigo-50 outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="block font-bold text-slate-500 mb-1">æ‰€åœ¨åœ°</label>
                    <select name="office" class="w-full px-3 py-2 rounded-lg border bg-slate-50 font-bold">
                        <option value="å°åŒ—">å°åŒ—</option><option value="å°ä¸­">å°ä¸­</option><option value="é«˜é›„">é«˜é›„</option>
                    </select>
                </div>
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <div class="flex items-center justify-between mb-1">
                        <label class="font-bold text-slate-700">å•Ÿç”¨æ ¡æ­£è¿½è¹¤</label>
                        <input type="checkbox" id="needsCalibration" name="needsCalibration" onchange="toggleDateInput(this)" checked class="w-4 h-4">
                    </div>
                    <div id="calibrationDateContainer">
                        <input type="date" name="calibrationDate" id="calibrationDateInput" class="w-full px-3 py-1.5 rounded border">
                    </div>
                </div>
                <div class="pt-2 flex gap-2">
                    <button type="button" onclick="closeModal('toolModal')" class="flex-1 py-2.5 bg-slate-100 rounded-xl font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBB8-yJhHg7J8dYu8_hhdw06EkS94Ey990",
        authDomain: "tool20250204.firebaseapp.com",
        projectId: "tool20250204",
        storageBucket: "tool20250204.firebasestorage.app",
        messagingSenderId: "515853558092",
        appId: "1:515853558092:web:b95dbcc0f33ebf0568efe9",
        measurementId: "G-YJ4FE646YM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'office-tool-sync';

    let tools = [];
    let returnMode = 'return';

    signInAnonymously(auth).catch(err => console.error("Auth Error", err));
    onAuthStateChanged(auth, u => { if (u) { startSync(); document.getElementById('loadingOverlay').classList.add('hidden'); } });

    function startSync() {
        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'tools');
        onSnapshot(colRef, (snapshot) => {
            tools = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            tools.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            window.renderTools();
        });
    }

    window.renderTools = () => {
        const tbody = document.getElementById('toolTableBody');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const officeFilter = document.getElementById('officeFilter').value;
        tbody.innerHTML = '';

        const filtered = tools.filter(tool => {
            const matchesSearch = tool.name.toLowerCase().includes(searchTerm) || 
                                tool.sn.toLowerCase().includes(searchTerm) || 
                                (tool.model && tool.model.toLowerCase().includes(searchTerm)) ||
                                (tool.owner && tool.owner.toLowerCase().includes(searchTerm)) ||
                                (tool.currentBorrower && tool.currentBorrower.toLowerCase().includes(searchTerm));
            const matchesOffice = officeFilter === 'all' || tool.office === officeFilter;
            return matchesSearch && matchesOffice;
        });

        if (filtered.length === 0) document.getElementById('noData').classList.remove('hidden');
        else document.getElementById('noData').classList.add('hidden');

        filtered.forEach(tool => {
            const cal = getCalibrationStatus(tool);
            const row = document.createElement('tr');
            if (tool.isBorrowed) row.classList.add('row-borrowed');
            row.className += " hover:bg-slate-50 transition-all border-b";

            row.innerHTML = `
                <td class="p-3 no-wrap">
                    <div class="font-bold text-slate-900 leading-tight">${tool.name}</div>
                    <div class="text-[10px] text-slate-500 font-medium">å‹è™Ÿ: ${tool.model || '-'}</div>
                    <div class="text-[10px] text-slate-400 font-mono">åºè™Ÿ: ${tool.sn || '-'}</div>
                    <div class="text-[10px] text-indigo-500 font-bold mt-0.5">ğŸ‘¤ ${tool.owner || '-'}</div>
                </td>
                <td class="p-3 no-wrap text-center">
                    <span class="text-[10px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">${tool.office}</span>
                </td>
                <td class="p-3 no-wrap text-center">
                    <div class="text-[11px] ${cal.textClass} leading-none">${tool.needsCalibration ? tool.calibrationDate : '--'}</div>
                    <div class="mt-1">${cal.badge}</div>
                </td>
                <td class="p-3 no-wrap text-center">
                    ${tool.isBorrowed ? `<span class="status-badge bg-amber-500 text-white">å€Ÿ: ${tool.currentBorrower}</span>` : `<span class="status-badge bg-emerald-500 text-white">åœ¨åº«</span>`}
                </td>
                <td class="p-3 text-center no-wrap">
                    <div class="flex items-center justify-center gap-2">
                        <button onclick="openBorrowModal('${tool.id}')" title="å€Ÿé‚„ä½œæ¥­" class="text-indigo-600 p-1"><i data-lucide="${tool.isBorrowed ? 'rotate-ccw' : 'share'}" class="w-4 h-4"></i></button>
                        <button onclick="showHistory('${tool.id}')" title="æŸ¥çœ‹å±¥æ­·" class="text-slate-400 hover:text-indigo-600 p-1"><i data-lucide="scroll-text" class="w-4 h-4"></i></button>
                        <button onclick="openEditModal('${tool.id}')" title="ç·¨è¼¯" class="text-slate-600 p-1"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                    </div>
                </td>`;
            tbody.appendChild(row);
        });
        updateStats();
        if (typeof lucide !== 'undefined') lucide.createIcons();
    };

    window.showHistory = (id) => {
        const tool = tools.find(t => t.id === id);
        document.getElementById('historyToolName').innerText = `${tool.name} (SN: ${tool.sn})`;
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if (!tool.history || tool.history.length === 0) list.innerHTML = '<p class="text-center text-slate-400 py-4">ç„¡ç´€éŒ„</p>';
        else {
            tool.history.forEach(log => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                let dotColor = 'bg-slate-300';
                if (log.type === 'borrow') dotColor = 'bg-amber-500';
                if (log.type === 'return') dotColor = 'bg-emerald-500';
                if (log.type === 'transfer') dotColor = 'bg-indigo-500';
                if (log.type === 'create') dotColor = 'bg-blue-600';
                item.innerHTML = `<div class="timeline-dot ${dotColor}"></div><div class="text-[9px] text-slate-400 font-bold mb-0.5">${log.date}</div><div class="bg-slate-50 border rounded-lg p-2 text-[11px] font-medium leading-relaxed">${log.msg}</div>`;
                list.appendChild(item);
            });
        }
        window.openModal('historyModal');
    };

    window.handleSaveTool = async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const id = document.getElementById('editToolId').value;
        const now = new Date().toLocaleString('zh-TW');
        const toolData = {
            name: f.get('name'), model: f.get('model'), sn: f.get('sn'), office: f.get('office'),
            owner: f.get('owner'), needsCalibration: f.get('needsCalibration') === 'on', calibrationDate: f.get('calibrationDate') || null
        };
        try {
            if (id) {
                const tool = tools.find(t => t.id === id);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tools', id), { ...toolData, history: [{ type: 'edit', date: now, msg: `è®Šæ›´è³‡æ–™/è² è²¬äºº` }, ...tool.history] });
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tools'), { ...toolData, createdAt: Date.now(), isBorrowed: false, currentBorrower: '', history: [{ type: 'create', date: now, msg: `è¨­å‚™æ–°å…¥åº« (${toolData.office})` }] });
            }
            closeModal('toolModal');
        } catch (err) { console.error(err); }
    };

    window.handleBorrowReturn = async () => {
        const id = document.getElementById('borrowToolId').value;
        const tool = tools.find(t => t.id === id);
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tools', id);
        const now = new Date().toLocaleString('zh-TW');
        if (!tool.isBorrowed) {
            const name = document.getElementById('borrowerName').value.trim();
            if (!name) return alert('å§“åï¼Ÿ');
            await updateDoc(docRef, { isBorrowed: true, currentBorrower: name, history: [{ type: 'borrow', date: now, msg: `å€Ÿçµ¦ ${name}` }, ...tool.history] });
        } else {
            if (returnMode === 'return') {
                const office = document.getElementById('returnOffice').value;
                await updateDoc(docRef, { isBorrowed: false, currentBorrower: "", office: office, history: [{ type: 'return', date: now, msg: `æ­¸é‚„æ–¼ ${office}` }, ...tool.history] });
            } else {
                const tName = document.getElementById('transferName').value.trim();
                if (!tName) return alert('æ¥æ”¶äººï¼Ÿ');
                await updateDoc(docRef, { currentBorrower: tName, history: [{ type: 'transfer', date: now, msg: `ç”± ${tool.currentBorrower} è½‰äº¤äºˆ ${tName}` }, ...tool.history] });
            }
        }
        closeModal('borrowModal');
    };

    window.getCalibrationStatus = (tool) => {
        if (!tool.needsCalibration || !tool.calibrationDate) return { badge: '', textClass: 'text-slate-300', level: 'none' };
        const diffDays = Math.ceil((new Date(tool.calibrationDate) - new Date().setHours(0,0,0,0)) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) return { badge: '<span class="status-badge bg-red-100 text-red-600 border px-1">éæœŸ</span>', textClass: 'text-red-600 font-bold', level: 'expired' };
        if (diffDays <= 60) return { badge: '<span class="status-badge bg-amber-50 text-amber-600 border px-1">é è­¦</span>', textClass: 'text-amber-600 font-bold', level: 'warning' };
        return { badge: '<span class="status-badge bg-blue-50 text-blue-500 border px-1">æœ‰æ•ˆ</span>', textClass: 'text-slate-500', level: 'ok' };
    };

    window.updateStats = () => {
        document.getElementById('statTotal').innerText = tools.length;
        document.getElementById('statBorrowed').innerText = tools.filter(t => t.isBorrowed).length;
        let w = 0, e = 0; tools.forEach(t => { const s = getCalibrationStatus(t); if(s.level === 'warning') w++; if(s.level === 'expired') e++; });
        document.getElementById('statWarning').innerText = w; document.getElementById('statExpired').innerText = e;
    };

    window.setReturnMode = (mode) => {
        returnMode = mode;
        const btnR = document.getElementById('modeBtnReturn');
        const btnT = document.getElementById('modeBtnTransfer');
        if (mode === 'return') {
            btnR.className = "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-amber-500 text-white shadow-sm";
            btnT.className = "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500";
            document.getElementById('returnLocationArea').classList.remove('hidden');
            document.getElementById('transferUserArea').classList.add('hidden');
        } else {
            btnT.className = "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-amber-500 text-white shadow-sm";
            btnR.className = "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500";
            document.getElementById('transferUserArea').classList.remove('hidden');
            document.getElementById('returnLocationArea').classList.add('hidden');
        }
    };

    window.openBorrowModal = (id) => {
        const tool = tools.find(t => t.id === id);
        document.getElementById('borrowToolId').value = id;
        const isB = tool.isBorrowed;
        document.getElementById('borrowTitle').innerText = isB ? "è™•ç½®ä½œæ¥­" : "å¤–å€Ÿä½œæ¥­";
        document.getElementById('borrowSub').innerText = isB ? `æŒæœ‰äººï¼š${tool.currentBorrower}` : "å¡«å¯«å€Ÿç”¨äºº";
        if (isB) { document.getElementById('borrowView').classList.add('hidden'); document.getElementById('returnView').classList.remove('hidden'); document.getElementById('returnOffice').value = tool.office; setReturnMode('return'); } 
        else { document.getElementById('borrowView').classList.remove('hidden'); document.getElementById('returnView').classList.add('hidden'); document.getElementById('borrowerName').value = ""; }
        window.openModal('borrowModal');
    };

    window.openEditModal = (id) => {
        const tool = tools.find(t => t.id === id);
        document.getElementById('editToolId').value = tool.id;
        const f = document.getElementById('toolForm');
        f.name.value = tool.name; f.model.value = tool.model || ""; f.sn.value = tool.sn || ""; f.office.value = tool.office; f.owner.value = tool.owner || ""; f.needsCalibration.checked = tool.needsCalibration; f.calibrationDate.value = tool.calibrationDate || "";
        window.toggleDateInput(f.needsCalibration); window.openModal('toolModal');
    };

    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.toggleDateInput = (cb) => document.getElementById('calibrationDateContainer').style.display = cb.checked ? 'block' : 'none';
    window.openAddModal = () => { document.getElementById('modalTitle').innerText = "æ–°å¢è¨­å‚™"; document.getElementById('editToolId').value = ""; document.getElementById('toolForm').reset(); window.openModal('toolModal'); };
</script>
</body>
</html>
