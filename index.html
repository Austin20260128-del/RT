<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工程師工具管理系統 - 行動格線版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        /* 極小化標籤字體但增加適度填充 */
        .status-badge { @apply px-2 py-0.5 rounded text-[7px] font-medium uppercase tracking-tighter leading-none flex items-center justify-center border border-transparent; }
        /* 增加列表項目內邊距：pl-14 確保文字明顯遠離螢幕左側邊緣 */
        .tool-item { @apply bg-white pl-14 pr-6 py-5 transition-all active:bg-slate-50 relative flex flex-col; }
        .loading-overlay { @apply fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] flex items-center justify-center text-white font-bold flex-col gap-4; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        input, select { font-size: 16px !important; } 
    </style>
</head>
<body class="text-slate-800 pb-24">

<!-- 載入中遮罩 -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent"></div>
    <p class="text-sm tracking-widest">同步雲端資料中...</p>
</div>

<div id="app" class="min-h-screen flex flex-col">
    <!-- 頂部導航 -->
    <nav class="bg-white border-b border-slate-100 p-2 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-1.5" onclick="location.reload()">
                <div class="bg-indigo-600 p-1 rounded-lg">
                    <i data-lucide="wrench" class="w-3 h-3 text-white"></i>
                </div>
                <h1 class="text-xs font-bold tracking-tight text-slate-900">雲端資產管理</h1>
            </div>
            <div id="connectionStatus" class="flex items-center text-[8px] text-slate-400 font-bold bg-slate-50 px-1.5 py-0.5 rounded-full border border-emerald-100/50">
                <span id="statusDot" class="w-1 h-1 bg-slate-300 rounded-full mr-1"></span>
                <span id="statusText">正在同步...</span>
            </div>
        </div>
    </nav>

    <div class="container mx-auto py-3 flex-grow">
        <!-- 狀態統計 -->
        <div class="grid grid-cols-2 gap-2 mb-3 px-4">
            <div class="bg-white p-2 rounded-lg border border-slate-100 shadow-sm shadow-slate-200/50">
                <p class="text-slate-400 text-[8px] font-bold uppercase">總資產</p>
                <h3 id="statTotal" class="text-base font-bold text-slate-700 leading-none mt-0.5">0</h3>
            </div>
            <div class="bg-white p-2 rounded-lg border border-slate-100 shadow-sm border-l-4 border-l-indigo-500">
                <p class="text-indigo-400 text-[8px] font-bold uppercase">借出中</p>
                <h3 id="statBorrowed" class="text-base font-bold text-indigo-600 leading-none mt-0.5">0</h3>
            </div>
            <div class="bg-white p-2 rounded-lg border border-slate-100 shadow-sm border-l-4 border-l-amber-500">
                <p class="text-amber-400 text-[8px] font-bold uppercase">快到期</p>
                <h3 id="statWarning" class="text-base font-bold text-amber-500 leading-none mt-0.5">0</h3>
            </div>
            <div class="bg-white p-2 rounded-lg border border-slate-100 shadow-sm border-l-4 border-l-red-500">
                <p class="text-red-400 text-[8px] font-bold uppercase">已過期</p>
                <h3 id="statExpired" class="text-base font-bold text-red-600 leading-none mt-0.5">0</h3>
            </div>
        </div>

        <!-- 搜尋與篩選 -->
        <div class="space-y-1.5 mb-4 px-4">
            <div class="relative">
                <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-2.5 h-2.5 text-slate-400"></i>
                <input type="text" id="searchInput" oninput="renderTools()" placeholder="搜尋名稱、管理者、所在地..." class="w-full pl-7 pr-3 py-1.5 rounded-lg bg-white border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm text-[9px] placeholder:text-slate-400">
            </div>
            <div class="flex gap-1 overflow-x-auto hide-scrollbar pb-0.5">
                <select id="officeFilter" onchange="renderTools()" class="bg-white border border-slate-200 px-2 py-1 rounded-md text-[9px] font-bold outline-none flex-shrink-0 text-slate-600">
                    <option value="all">所有辦公室</option>
                    <option value="台北">台北</option>
                    <option value="台中">台中</option>
                    <option value="高雄">高雄</option>
                </select>
                <select id="statusFilter" onchange="renderTools()" class="bg-white border border-slate-200 px-2 py-1 rounded-md text-[9px] font-bold outline-none flex-shrink-0 text-slate-600">
                    <option value="all">所有狀態</option>
                    <option value="in-stock">在庫</option>
                    <option value="borrowed">外借中</option>
                    <option value="warning">快到期</option>
                    <option value="expired">已過期</option>
                </select>
            </div>
        </div>

        <!-- 儀器清單容器：去除左右邊框 -->
        <div class="bg-white border-t border-b border-slate-200 overflow-hidden shadow-sm shadow-slate-200/50">
            <div id="toolListContainer" class="divide-y divide-slate-100"></div>
        </div>

        <div id="noData" class="hidden py-12 text-center flex flex-col items-center px-4">
            <div class="bg-slate-100 p-3 rounded-full mb-2 text-slate-300">
                <i data-lucide="inbox" class="w-6 h-6"></i>
            </div>
            <p class="text-slate-400 text-xs font-medium">目前沒有任何資產</p>
        </div>
    </div>

    <!-- 懸浮按鈕 -->
    <button onclick="openAddModal()" class="fixed bottom-6 right-6 w-11 h-11 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-500/40 flex items-center justify-center z-50 active:scale-90 transition-transform">
        <i data-lucide="plus" class="w-5 h-5"></i>
    </button>

    <!-- Modal: 新增/編輯 -->
    <div id="toolModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-end md:items-center justify-center z-[100] p-0 md:p-4">
        <div class="bg-white rounded-t-2xl md:rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden border border-white/20 animate-in slide-in-from-bottom duration-300">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h2 id="modalTitle" class="text-sm font-bold text-slate-900">資產資料編輯</h2>
                <button onclick="closeModal('toolModal')" class="bg-white p-1 rounded-full shadow-sm"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
            </div>
            <form id="toolForm" onsubmit="handleSaveTool(event)" class="p-4 space-y-3 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="editToolId">
                <div class="space-y-3">
                    <div>
                        <label class="block text-[8px] font-black text-slate-400 uppercase mb-0.5">工具名稱</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 rounded-lg border-slate-200 border outline-none bg-slate-50 focus:bg-white text-xs">
                    </div>
                    <div>
                        <label class="block text-[8px] font-black text-slate-400 uppercase mb-0.5">工具管理者</label>
                        <input type="text" name="manager" required placeholder="負責人姓名" class="w-full px-3 py-2 rounded-lg border-slate-200 border outline-none bg-slate-50 focus:bg-white font-bold text-indigo-600 text-xs">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[8px] font-black text-slate-400 uppercase mb-0.5">型號</label>
                            <input type="text" name="model" required class="w-full px-3 py-2 rounded-lg border-slate-200 border outline-none bg-slate-50 text-xs">
                        </div>
                        <div>
                            <label class="block text-[8px] font-black text-slate-400 uppercase mb-0.5">序號 (S/N)</label>
                            <input type="text" name="sn" required class="w-full px-3 py-2 rounded-lg border-slate-200 border outline-none bg-slate-50 text-xs">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[8px] font-black text-slate-400 uppercase mb-0.5">目前所在辦公室</label>
                        <select name="office" class="w-full px-3 py-2 rounded-lg border-slate-200 border outline-none bg-slate-50 text-xs">
                            <option value="台北">台北辦公室</option>
                            <option value="台中">台中辦公室</option>
                            <option value="高雄">高雄辦公室</option>
                        </select>
                    </div>
                    <div class="p-3 bg-indigo-50/50 rounded-xl border border-indigo-100 space-y-2">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] font-bold text-indigo-900">追蹤校正到期日</label>
                            <input type="checkbox" id="needsCalibration" name="needsCalibration" onchange="toggleDateInput(this)" checked class="w-3.5 h-3.5 rounded border-indigo-300 text-indigo-600">
                        </div>
                        <div id="calibrationDateContainer">
                            <input type="date" name="calibrationDate" id="calibrationDateInput" class="w-full px-2 py-1.5 rounded-lg border-indigo-200 border text-xs">
                        </div>
                    </div>
                </div>
                <div class="pt-2 flex gap-3">
                    <button type="submit" id="saveBtn" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 active:scale-95 transition-all text-xs">確認存檔</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: 借還與轉交 -->
    <div id="borrowModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-[110] p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-5 text-center animate-in zoom-in duration-200">
            <h2 id="borrowTitle" class="text-base font-bold mb-1">工具借用</h2>
            <p id="borrowSub" class="text-slate-400 text-[9px] mb-4"></p>
            <input type="hidden" id="borrowToolId">
            
            <div id="borrowerInputWrapper" class="mb-4">
                <input type="text" id="borrowerName" placeholder="工程師姓名" class="w-full px-3 py-2.5 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none text-center text-sm font-bold">
            </div>
            
            <div id="returnOptionsWrapper" class="hidden mb-4 space-y-3 text-left">
                <div class="p-2.5 bg-emerald-50 rounded-xl border border-emerald-100 text-center">
                    <p class="text-emerald-800 font-bold text-[8px] mb-1.5 uppercase tracking-wider">工具存放地點</p>
                    <select id="returnLocation" class="w-full px-2 py-2 rounded-lg border-2 border-emerald-200 outline-none font-bold text-emerald-700 bg-white text-xs">
                        <option value="台北">台北辦公室</option>
                        <option value="台中">台中辦公室</option>
                        <option value="高雄">高雄辦公室</option>
                    </select>
                </div>

                <div class="px-1 flex items-center gap-2">
                    <input type="checkbox" id="isTransfer" onchange="toggleTransferUI(this)" class="w-3.5 h-3.5 rounded text-indigo-600 border-slate-300">
                    <label for="isTransfer" class="text-[10px] font-bold text-slate-700">直接轉交給其他同仁</label>
                </div>

                <div id="transferInputWrapper" class="hidden p-2.5 bg-amber-50 rounded-xl border border-amber-100 text-center">
                    <p class="text-amber-800 font-bold text-[8px] mb-1.5 uppercase tracking-wider">新借用人姓名</p>
                    <input type="text" id="newBorrowerName" placeholder="接收人姓名" class="w-full px-2 py-2 rounded-lg border-2 border-amber-200 outline-none font-bold text-amber-700 bg-white text-xs text-center">
                </div>
            </div>

            <div class="flex flex-col gap-1.5">
                <button id="borrowConfirmBtn" onclick="handleBorrowReturn()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold transition-all active:scale-95 shadow-md text-xs">確認提交</button>
                <button onclick="closeModal('borrowModal')" class="w-full py-1.5 text-slate-400 text-[10px] font-bold">取消</button>
            </div>
        </div>
    </div>

    <!-- Modal: 履歷 -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-end md:items-center justify-center z-[100] p-0 md:p-4">
        <div class="bg-white rounded-t-2xl md:rounded-2xl w-full max-w-lg h-[75vh] flex flex-col overflow-hidden animate-in slide-in-from-bottom duration-300">
            <div class="p-3.5 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-sm font-bold text-slate-900">資產履歷與管理</h2>
                <button onclick="closeModal('historyModal')" class="p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="historyTimeline" class="flex-grow overflow-y-auto p-4 space-y-4 hide-scrollbar"></div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 translate-y-24 opacity-0 transition-all duration-500 z-[120] bg-slate-800 text-white px-5 py-2.5 rounded-full shadow-2xl text-[10px] font-bold flex items-center gap-1.5">
        <i data-lucide="check-circle" class="w-3 h-3 text-emerald-400"></i>
        <span id="toastMsg"></span>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 系統提供之環境變數 (Rule 1)
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-tool-app';

    let tools = [];
    let user = null;

    window.initIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };

    // 認證程序 (Rule 3)
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Firebase Auth Error", e);
            updateConnectionStatus(false);
        }
    };

    onAuthStateChanged(auth, (u) => {
        user = u;
        if (u) {
            updateConnectionStatus(true);
            startSync();
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    });

    function updateConnectionStatus(connected) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        if (connected) {
            dot.className = "w-1 h-1 bg-emerald-500 rounded-full mr-1 animate-pulse";
            text.innerText = "跨區同步中";
            text.className = "text-emerald-600";
        } else {
            dot.className = "w-1 h-1 bg-red-500 rounded-full mr-1";
            text.innerText = "連線失敗";
            text.className = "text-red-600";
        }
    }

    // 啟動即時監聽 (Rule 1 & 2)
    function startSync() {
        if (!user) return;
        // 使用正確的路徑架構以符合權限規則
        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'tools');
        onSnapshot(colRef, (snapshot) => {
            tools = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            tools.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            window.renderTools();
        }, (err) => {
            console.error("Firestore Permission Error:", err);
            showToast("同步失敗：權限不足");
        });
    }

    window.renderTools = () => {
        const container = document.getElementById('toolListContainer');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const officeF = document.getElementById('officeFilter').value;
        const statusF = document.getElementById('statusFilter').value;
        container.innerHTML = '';

        const filtered = tools.filter(t => {
            const cal = getCalibrationStatus(t);
            const matchS = t.name.toLowerCase().includes(searchTerm) || t.sn.toLowerCase().includes(searchTerm) || (t.manager && t.manager.toLowerCase().includes(searchTerm)) || (t.currentBorrower && t.currentBorrower.toLowerCase().includes(searchTerm));
            const matchO = officeF === 'all' || t.office === officeF;
            let matchSt = true;
            if (statusF === 'borrowed') matchSt = t.isBorrowed;
            else if (statusF === 'in-stock') matchSt = !t.isBorrowed;
            else if (statusF === 'warning') matchSt = cal.level === 'warning';
            else if (statusF === 'expired') matchSt = cal.level === 'expired';
            return matchS && matchO && matchSt;
        });

        document.getElementById('noData').style.display = filtered.length === 0 ? 'flex' : 'none';

        filtered.forEach(t => {
            const cal = getCalibrationStatus(t);
            const item = document.createElement('div');
            item.className = `tool-item ${t.isBorrowed ? 'bg-amber-50/20' : ''}`;
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-grow pr-4">
                        <h4 class="font-bold text-slate-800 leading-tight text-xs tracking-tight">${t.name}</h4>
                        <div class="flex items-center gap-1 mt-1">
                            <i data-lucide="shield-check" class="w-2.5 h-2.5 text-indigo-500"></i>
                            <span class="text-[8px] font-bold text-indigo-600 leading-none">管理人：${t.manager || '未設定'}</span>
                        </div>
                        <p class="text-[8px] font-mono text-slate-400 mt-1 leading-none uppercase tracking-tighter">${t.model} · SN: ${t.sn}</p>
                    </div>
                    <div class="flex flex-row gap-1 items-start flex-shrink-0 pr-1">
                        <span class="status-badge bg-slate-100 text-slate-500"><i data-lucide="map-pin" class="w-1.5 h-1.5 mr-0.5 text-slate-400"></i> ${t.office}</span>
                        ${t.isBorrowed ? `<span class="status-badge bg-amber-500 text-white shadow-sm">持有: ${t.currentBorrower}</span>` : `<span class="status-badge bg-emerald-500 text-white shadow-sm">在庫</span>`}
                    </div>
                </div>
                <div class="flex items-center justify-between pt-2 border-t border-slate-50 mt-1">
                    <div class="flex flex-col">
                        <span class="text-[7px] text-slate-400 font-bold uppercase tracking-tighter">下次校正</span>
                        <span class="text-[9px] font-bold ${cal.textClass} leading-tight">${t.needsCalibration ? t.calibrationDate : '---'}</span>
                    </div>
                    <div class="flex gap-1.5 pr-1">
                        <button onclick="openBorrowModal('${t.id}')" class="p-2.5 ${t.isBorrowed ? 'bg-amber-100 text-amber-600' : 'bg-indigo-50 text-indigo-600'} rounded-lg active:scale-90 transition-transform"><i data-lucide="${t.isBorrowed ? 'repeat' : 'share-2'}" class="w-3.5 h-3.5"></i></button>
                        <button onclick="openEditModal('${t.id}')" class="p-2.5 bg-slate-50 text-slate-500 rounded-lg active:scale-90 transition-transform"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                        <button onclick="viewHistory('${t.id}')" class="p-2.5 text-slate-300 hover:text-slate-600"><i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>`;
            container.appendChild(item);
        });
        updateStats();
        window.initIcons();
    };

    function getCalibrationStatus(t) {
        if (!t.needsCalibration || !t.calibrationDate) return { textClass: 'text-slate-300', level: 'none' };
        const diff = Math.ceil((new Date(t.calibrationDate) - new Date().setHours(0,0,0,0)) / 86400000);
        if (diff < 0) return { textClass: 'text-red-600', level: 'expired' };
        if (diff <= 60) return { textClass: 'text-amber-600 font-bold', level: 'warning' };
        return { textClass: 'text-slate-500', level: 'ok' };
    }

    function updateStats() {
        const total = tools.length;
        const borrowed = tools.filter(t => t.isBorrowed).length;
        let w = 0, e = 0;
        tools.forEach(t => {
            const s = getCalibrationStatus(t);
            if(s.level === 'warning') w++;
            if(s.level === 'expired') e++;
        });
        document.getElementById('statTotal').innerText = total;
        document.getElementById('statBorrowed').innerText = borrowed;
        document.getElementById('statWarning').innerText = w;
        document.getElementById('statExpired').innerText = e;
    }

    window.handleSaveTool = async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const id = document.getElementById('editToolId').value;
        const now = new Date().toLocaleString('zh-TW');
        const data = { name: f.get('name'), manager: f.get('manager'), model: f.get('model'), sn: f.get('sn'), office: f.get('office'), needsCalibration: f.get('needsCalibration') === 'on', calibrationDate: f.get('calibrationDate') || null };
        try {
            if (id) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tools', id);
                const tool = tools.find(t => t.id === id);
                await updateDoc(docRef, { ...data, history: [{ type: 'edit', date: now, msg: `變更資料 (${data.office} 管理: ${data.manager})` }, ...tool.history] });
                showToast("已更新");
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tools'), { ...data, createdAt: Date.now(), isBorrowed: false, currentBorrower: '', history: [{ type: 'create', date: now, msg: `入庫建檔 (${data.office} 管理: ${data.manager})` }] });
                showToast("已建檔");
            }
            closeModal('toolModal');
        } catch (err) { showToast("存檔失敗"); }
    };

    window.handleBorrowReturn = async () => {
        const id = document.getElementById('borrowToolId').value;
        const tool = tools.find(t => t.id === id);
        const now = new Date().toLocaleString('zh-TW');
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tools', id);
        try {
            if (!tool.isBorrowed) {
                const name = document.getElementById('borrowerName').value.trim();
                if (!name) return showToast('請填寫姓名');
                await updateDoc(docRef, { isBorrowed: true, currentBorrower: name, history: [{ type: 'borrow', date: now, msg: `${name} 借出` }, ...tool.history] });
                showToast(`已借出`);
            } else {
                const isTransfer = document.getElementById('isTransfer').checked;
                const returnOffice = document.getElementById('returnLocation').value;
                const oldName = tool.currentBorrower;
                if (isTransfer) {
                    const newName = document.getElementById('newBorrowerName').value.trim();
                    if (!newName) return showToast('請填寫接收人');
                    await updateDoc(docRef, { currentBorrower: newName, office: returnOffice, history: [{ type: 'transfer', date: now, msg: `由 ${oldName} 轉交給 ${newName} (${returnOffice})` }, ...tool.history] });
                    showToast(`已轉交`);
                } else {
                    await updateDoc(docRef, { isBorrowed: false, currentBorrower: "", office: returnOffice, history: [{ type: 'return', date: now, msg: `${oldName} 歸還至 ${returnOffice}` }, ...tool.history] });
                    showToast(`已歸還`);
                }
            }
            document.getElementById('borrowerName').value = ""; document.getElementById('newBorrowerName').value = ""; closeModal('borrowModal');
        } catch (err) { showToast("提交失敗"); }
    };

    window.toggleTransferUI = (cb) => {
        document.getElementById('transferInputWrapper').classList.toggle('hidden', !cb.checked);
        document.getElementById('borrowConfirmBtn').innerText = cb.checked ? "確認轉交" : "確認歸還";
    };

    window.deleteTool = async (id) => {
        if (!confirm('永久刪除？')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tools', id));
            closeModal('historyModal'); showToast('已移除');
        } catch (err) { showToast("刪除失敗"); }
    };

    window.openAddModal = () => { document.getElementById('modalTitle').innerText = "資產建檔"; document.getElementById('editToolId').value = ""; document.getElementById('toolForm').reset(); window.openModal('toolModal'); };
    window.openEditModal = (id) => { const t = tools.find(x => x.id === id); document.getElementById('modalTitle').innerText = "資產編輯"; document.getElementById('editToolId').value = t.id; const f = document.getElementById('toolForm'); f.name.value = t.name; f.manager.value = t.manager || ""; f.model.value = t.model; f.sn.value = t.sn; f.office.value = t.office; f.needsCalibration.checked = t.needsCalibration; f.calibrationDate.value = t.calibrationDate || ""; window.toggleDateInput(f.needsCalibration); window.openModal('toolModal'); };
    window.openBorrowModal = (id) => { const t = tools.find(x => x.id === id); document.getElementById('borrowToolId').value = id; const isB = t.isBorrowed; document.getElementById('borrowTitle').innerText = isB ? "狀態變更 / 歸還" : "借出登記"; document.getElementById('borrowSub').innerText = isB ? `持有：${t.currentBorrower}` : `登記：${t.name}`; document.getElementById('borrowerInputWrapper').classList.toggle('hidden', isB); document.getElementById('returnOptionsWrapper').classList.toggle('hidden', !isB); const tfCheckbox = document.getElementById('isTransfer'); tfCheckbox.checked = false; window.toggleTransferUI(tfCheckbox); if (isB) document.getElementById('returnLocation').value = t.office; const btn = document.getElementById('borrowConfirmBtn'); if(!isB) { btn.innerText = "確認借出"; btn.className = "w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold shadow-md text-sm"; } window.openModal('borrowModal'); };
    window.viewHistory = (id) => { const t = tools.find(x => x.id === id); const list = document.getElementById('historyTimeline'); list.innerHTML = `<button onclick="deleteTool('${t.id}')" class="w-full py-2 mb-4 bg-red-50 text-red-600 rounded-xl font-bold text-[10px] border border-red-100 uppercase tracking-widest">永久移除資料</button><div class="space-y-4"></div>`; const container = list.querySelector('.space-y-4'); if(t.history) { t.history.forEach(log => { const item = document.createElement('div'); item.className = "flex gap-3 relative"; let color = "bg-slate-300"; if(log.type === 'borrow') color = "bg-amber-500"; if(log.type === 'return') color = "bg-emerald-500"; if(log.type === 'transfer') color = "bg-indigo-500"; item.innerHTML = `<div class="w-1.5 h-1.5 rounded-full ${color} mt-1 flex-shrink-0 z-10 shadow-sm"></div><div class="pb-1 border-l border-slate-100 pl-4 ml-[-14px]"><p class="text-[7px] font-bold text-slate-400 tracking-tighter">${log.date}</p><p class="text-[10px] font-bold text-slate-700 leading-snug">${log.msg}</p></div>`; container.appendChild(item); }); } window.openModal('historyModal'); window.initIcons(); };
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.toggleDateInput = (cb) => document.getElementById('calibrationDateContainer').style.display = cb.checked ? 'block' : 'none';
    function showToast(msg) { const t = document.getElementById('toast'); const m = document.getElementById('toastMsg'); if (m) m.innerText = msg; if (t) { t.classList.remove('translate-y-24', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 2500); } }

    initAuth();
    window.initIcons();
</script>

</body>
</html>
